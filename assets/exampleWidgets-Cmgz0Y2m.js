import{j as p}from"./jsx-runtime-PJfywvQB.js";import{r as t}from"./index-tnPESBdE.js";import{c as I,u as D,a as M,s as U,r as R,b as O,F as V,d as B}from"./createSmartContext-lZxL_nvM.js";import{p as N}from"./navigateObject-ZMXbUPar.js";import"./index-C4WGByT4.js";import"./parchmentTheme-CF6Ki9yW.js";import{I as G,S as _,N as z,C as H}from"./useShowToast-xIu4UuDl.js";const T=I({data:void 0,fieldSettings:void 0,aggregatedData:void 0}),J=T.Provider;function w(){return new Error("Must provide PartialDataSubscriptionContextProvider")}const q=t.createContext({updateDataAtPath:()=>{throw w()},updateFieldSettingsAtPath:()=>{throw w()}}),K=q.Provider;function Q(e){const s=t.useMemo(()=>{const a=N(e);return{dataLocation:["data",...a],fieldSettingsLocation:["fieldSettings",...a],aggregatedDataLocation:["aggregatedData",...a]}},[e]),r=D(T,s.dataLocation),c=D(T,s.fieldSettingsLocation),n=D(T,s.aggregatedDataLocation),{updateDataAtPath:o,updateFieldSettingsAtPath:l}=t.useContext(q),u=t.useCallback(a=>{o(e,a)},[e,o]),i=t.useCallback(a=>{l(e,a)},[e,l]);return{data:r,updateData:u,aggregatedData:n,fieldSettingsData:c,updateFieldSettings:i}}function W(e,s,r,c=300){const n=t.useRef([]),o=t.useRef(),l=t.useRef(r),u=t.useRef(s),i=t.useRef(e);t.useEffect(()=>{l.current=r},[r]),t.useEffect(()=>{u.current=s},[s]),t.useEffect(()=>{i.current=e},[e]),t.useEffect(()=>()=>o.current&&clearTimeout(o.current),[]);const a=t.useCallback(()=>Object.values(n.current.reduce((f,m)=>(f[m.path]=m,f),{})),[]),g=t.useCallback(()=>{const f=a(),m=M(u.current);for(const h of f)U({root:m,location:h.path,value:h.update,schema:i.current});n.current=[],l.current(m)},[a]);return t.useCallback((f,m)=>{o.current&&(clearTimeout(o.current),o.current=void 0),n.current.push({path:f,update:m}),o.current=setTimeout(g,c)},[c,g])}const j=({path:e,Widget:s,label:r,aggregation:c,schema:n,entityApi:o,currentUserRole:l,shouldShowFieldSettingControls:u,aggregationSupport:i})=>{const{data:a,aggregatedData:g,fieldSettingsData:y,updateData:f,updateFieldSettings:m}=Q(e),h=a??(n==null?void 0:n.default),[b,k]=t.useState(h),[d,x]=t.useState(y);t.useEffect(()=>{k(h)},[h]),t.useEffect(()=>{x(y)},[y]);const v=t.useCallback(C=>{k(C),f(C)},[f]),E=t.useCallback(C=>{x(C),m==null||m(C)},[m]),L=t.useMemo(()=>R(g,d==null?void 0:d.aggregationSettings),[d==null?void 0:d.aggregationSettings,g]),S=t.useMemo(()=>R(c,d==null?void 0:d.aggregationSettings),[d==null?void 0:d.aggregationSettings,c]);return p.jsx(s,{value:b,onChange:v,label:r,aggregatedValue:L,aggregation:S,schema:n,entityApi:o,fieldSettings:d,updateFieldSettings:u?E:void 0,aggregationSupport:i,currentUserRole:l})};j.__docgenInfo={description:"",methods:[],displayName:"DebouncedWidget",props:{path:{required:!0,tsType:{name:"string"},description:""},aggregation:{required:!0,tsType:{name:"union",raw:"Aggregates | string | undefined",elements:[{name:"Aggregates"},{name:"string"},{name:"undefined"}]},description:""},Widget:{required:!0,tsType:{name:"ReactFC",raw:"React.FC<React.PropsWithChildren<WidgetProps<T>>>",elements:[{name:"ReactPropsWithChildren",raw:"React.PropsWithChildren<WidgetProps<T>>",elements:[{name:"WidgetProps",elements:[{name:"T"}],raw:"WidgetProps<T>"}]}]},description:""},schema:{required:!0,tsType:{name:"CampaignBuddySchema"},description:""},entityApi:{required:!0,tsType:{name:"union",raw:"EntityApi | undefined",elements:[{name:"EntityApi"},{name:"undefined"}]},description:""},shouldShowFieldSettingControls:{required:!0,tsType:{name:"boolean"},description:""},aggregationSupport:{required:!0,tsType:{name:"unknown"},description:""}},composes:["Omit"]};const X={},Y={},Z=({schema:e,data:s=X,onChange:r,widgets:c,uiLayout:n,UiSection:o,aggregates:l,entityApi:u,updateFieldSettings:i,fieldSettings:a=Y,currentUserRole:g})=>{const{resolvedSchema:y,aggregatedData:f,uiLayout:m,fullAggregates:h}=O({schema:e,data:s,currentUserRole:g,aggregates:l,providedUiLayout:n,fieldSettings:a,entityApi:u}),b=W(e,s,r),k=t.useCallback(v=>{i==null||i(v)},[i]),d=W(e,a,k),x=t.useMemo(()=>({updateDataAtPath:b,updateFieldSettingsAtPath:d}),[b,d]);return p.jsx(V,{children:p.jsx(K,{value:x,children:p.jsx(J,{value:{data:s,fieldSettings:a,aggregatedData:f},children:p.jsx(B,{uiLayout:m,schema:y,widgetLookup:c,UiSection:o,aggregates:h,entityApi:u,shouldShowFieldSettingControls:!!i,currentUserRole:g,FormWidgetRenderer:j})})})})};Z.__docgenInfo={description:"",methods:[],displayName:"FormGenerator",props:{schema:{required:!0,tsType:{name:"CampaignBuddySchema"},description:""},data:{required:!1,tsType:{name:"any"},description:"",defaultValue:{value:"{}",computed:!1}},onChange:{required:!0,tsType:{name:"signature",type:"function",raw:"(data: any) => void",signature:{arguments:[{type:{name:"any"},name:"data"}],return:{name:"void"}}},description:""},widgets:{required:!0,tsType:{name:"WidgetLookup"},description:""},uiLayout:{required:!1,tsType:{name:"Array",elements:[{name:"unknown"}],raw:`(
	| string
	| UiSection
	| ColumnLayout
	| WhiteSpace
	| UiLayout
)[]`},description:""},UiSection:{required:!1,tsType:{name:"ReactFC",raw:"React.FC<React.PropsWithChildren<UiSectionProps>>",elements:[{name:"ReactPropsWithChildren",raw:"React.PropsWithChildren<UiSectionProps>",elements:[{name:"UiSectionProps"}]}]},description:""},aggregates:{required:!1,tsType:{name:"Aggregates"},description:""},entityApi:{required:!1,tsType:{name:"EntityApi"},description:`Not technically needed, but some
widgets may fail if an entity
api is not provided`},fieldSettings:{required:!1,tsType:{name:"EntityFieldSettings"},description:`Field level settings for the data being
operated on`,defaultValue:{value:"{}",computed:!1}},updateFieldSettings:{required:!1,tsType:{name:"signature",type:"function",raw:"(fieldSettings: EntityFieldSettings) => void",signature:{arguments:[{type:{name:"EntityFieldSettings"},name:"fieldSettings"}],return:{name:"void"}}},description:`Allows for widget components to update field settings
for individual fields`},currentUserRole:{required:!1,tsType:{name:"string"},description:`The role of the current user. The semantic
values for role is left to the consumer. This
property is used to match field visibility
settings in fieldSettings. If left undefined,
it is assumed the current user has all visibility
permissions.`}}};const F="gm",$="player",A=({value:e,onChange:s,label:r,aggregatedValue:c,updateFieldSettings:n,fieldSettings:o,aggregation:l,currentUserRole:u})=>{const[i,a]=t.useState(!1),g=t.useCallback(()=>a(!1),[]),y=t.useCallback(()=>a(!0),[]);return p.jsx(P,{updateFieldSettings:n,currentUserRole:u,fieldSettings:o,children:p.jsx(G,{value:!i&&l?c??"":e??"",onChange:s,onFocus:y,onBlur:g,label:r})})},ee=({value:e,onChange:s,label:r,aggregatedValue:c,aggregation:n,updateFieldSettings:o,currentUserRole:l,fieldSettings:u})=>{const[i,a]=t.useState(!1),g=t.useCallback(()=>a(!1),[]),y=t.useCallback(()=>a(!0),[]);return p.jsx(P,{updateFieldSettings:o,currentUserRole:l,fieldSettings:u,children:p.jsx(z,{value:!i&&n?c??0:e??0,onChange:s,label:r,onFocus:y,onBlur:g})})},te=({value:e,onChange:s,label:r,aggregatedValue:c,aggregation:n,updateFieldSettings:o,currentUserRole:l,fieldSettings:u})=>{const[i,a]=t.useState(!1),g=t.useCallback(()=>a(!1),[]),y=t.useCallback(()=>a(!0),[]);return p.jsx(P,{updateFieldSettings:o,currentUserRole:l,fieldSettings:u,children:p.jsx(_,{value:!i&&n?c??!1:e??!1,onChange:s,label:r,onFocus:y,onBlur:g})})},ae=()=>p.jsx("p",{children:"Derp"}),le={string:A,number:ee,boolean:te,array:ae,randoType:A},P=({fieldSettings:e,currentUserRole:s,updateFieldSettings:r,children:c})=>{var o,l;const n=[];if(s===F&&r&&n.push({displayText:"Compute this field?",icon:(e==null?void 0:e.aggregationSettings)===!1?"blank":"tick",onClick:()=>{r({...e??{},aggregationSettings:!((e==null?void 0:e.aggregationSettings)??!0)})},shouldCloseMenuOnClick:!1}),s===F&&r){const u=i=>{r({...e??{},visibleRoles:i})};n.push({displayText:"Visibility settings",icon:"eye-open",subItems:[{displayText:"Use default settings",icon:e!=null&&e.visibleRoles?"blank":"tick",onClick:()=>u(),shouldCloseMenuOnClick:!1},{displayText:"Game master only",icon:((o=e==null?void 0:e.visibleRoles)==null?void 0:o.length)===1?"tick":"blank",onClick:()=>u([F]),shouldCloseMenuOnClick:!1},{displayText:"Everyone",icon:((l=e==null?void 0:e.visibleRoles)==null?void 0:l.length)===2?"tick":"blank",onClick:()=>u([F,$]),shouldCloseMenuOnClick:!1}]})}return n.length?p.jsx(H,{menuItems:n,children:c}):p.jsx(p.Fragment,{children:c})};export{Z as F,le as e};
