import{r as N,R as f}from"./index-tnPESBdE.js";import{o as y,s as p,n as R,b as D,e as L,a as _,m as $,f as H,d as U,i as j,r as T,c as b}from"./jsonSchemaTypes-BjqZX6rF.js";import{F as B}from"./fuse.esm-BSXXkDLL.js";import{w as F,b as O,q as P,x as A,u as K,Q,a as q}from"./index.esm-CPT3nVmo.js";import{j as g}from"./jsx-runtime-PJfywvQB.js";import{H as w,C as V}from"./styled-components.browser.esm-CuL3HyEV.js";function ke(){const a=N.useRef(!0);return N.useEffect(()=>()=>{a.current=!1},[]),a}function d(){return`${new Date().getMilliseconds()}${Math.random()}`}class W{constructor(i){var e;this.simulateLatency=()=>new Promise(t=>{setTimeout(()=>t(),this.mockLatencyMs)}),this.generateId=()=>d(),this.mockLatencyMs=(e=i.mockLatencyMs)!==null&&e!==void 0?e:1e3}}const z=[{id:d(),entityData:{name:"Bard",description:"Its a bard",bonus:{maxHp:1}},definitionName:"characterClass"},{id:d(),entityData:{name:"Fighter",description:"Its a fighter",bonus:{maxHp:2}},definitionName:"characterClass"},{id:d(),entityData:{name:"Wizard",description:"Its a wizard",bonus:{maxHp:3}},definitionName:"characterClass"},{id:d(),entityData:{name:"Rouge",description:"Its a rouge",bonus:{maxHp:4}},definitionName:"characterClass"},{id:d(),entityData:{name:"Potion smith",description:"Its a potion smith",bonus:{maxHp:5}},definitionName:"characterClass"},{id:d(),entityData:{name:"Sorcerer",description:"Its a sorcerer",bonus:{maxHp:6}},definitionName:"characterClass"},{id:d(),entityData:{name:"Ranger",description:"Its a ranger",bonus:{maxHp:7}},definitionName:"characterClass"},{id:d(),entityData:{name:"Paladin",description:"Its a paladin",bonus:{maxHp:8}},definitionName:"characterClass"},{id:d(),entityData:{name:"Monk",description:"Its a monk",bonus:{maxHp:9}},definitionName:"characterClass"},{id:d(),entityData:{name:"Cleric",description:"Its a cleric",bonus:{maxHp:10}},definitionName:"characterClass"},{id:d(),entityData:{name:"Barbarian",description:"Its a barbarian",bonus:{maxHp:11}},definitionName:"characterClass"}],Y=[{id:d(),entityData:{name:"Somewhat beefy",description:"Kinda beefy",bonus:{maxHp:1}},definitionName:"feat"},{id:d(),entityData:{name:"Pretty beefy",description:"Its pretty beefy",bonus:{maxHp:2}},definitionName:"feat"},{id:d(),entityData:{name:"Beefy",description:"I'd say its beefy",bonus:{maxHp:3}},definitionName:"feat"},{id:d(),entityData:{name:"Very beefy",description:"Its very beefy",bonus:{maxHp:4}},definitionName:"feat"},{id:d(),entityData:{name:"SUPER BEEFY",description:"Its a super duper",bonus:{maxHp:5}},definitionName:"feat"}],X=y({name:p({title:"Name",cols:12}),description:p({title:"Description",cols:12}),bonuses:y({maxHp:R()})}),G={name:"characterClass",schema:X,propertyMap:{displayName:"name"}},J=y({name:p({title:"Name",cols:12}),description:p({title:"Description",cols:12}),bonus:y({maxHp:R()})}),M={schema:J,name:"feat",propertyMap:{displayName:"name"}},Z=y({name:p({title:"Name"}),playerName:p({title:"Player Name",cols:4}),profileImage:j({title:"Image"}),age:R({title:"Age"}),race:U({title:"Race",options:["Human","Elf","Halfling","Dwarf","Gnome","Dragonborn","Tiefling"],aggregate:{options:'TO_OPTIONS_FROM_STRINGS(SPLIT(",", {$.customRaces}))'}}),feats:H(M,{title:"Feats"}),favoriteColors:$({title:"Favorite Colors",options:["Red","Blue","Yellow","Green","Brown","Pink","Black","Purple"],aggregate:{options:'TO_OPTIONS_FROM_STRINGS(SPLIT(",", {$.customColors}))'}}),hp:_({title:"HP",cols:4,aggregate:{max:"TO_NUMBER(<base>) + SUM({$..bonus.maxHp})"}}),speed:R({title:"Speed"}),armorClass:R({title:"AC"}),class:L(G,{title:"Class"}),customRaces:p({title:"Custom races (comma separated)"}),customColors:p({title:"Custom colors (comma separated)"}),isPlayer:D({title:"Is player controlled?",aggregate:"TO_BOOLEAN({$.playerName})"}),stats:y({str:b({title:"STR",aggregate:{bonus:I("str")}}),dex:b({title:"DEX",aggregate:{bonus:I("dex")}}),con:b({title:"CON",aggregate:{bonus:I("con")}}),int:b({title:"INT",aggregate:{bonus:I("int")}}),wis:b({title:"WIS",aggregate:{bonus:I("wis")}}),cha:b({title:"CHA",aggregate:{bonus:I("cha")}})}),cosmetics:y({bio:T({title:"Bio"}),height:p({title:"Height"}),weight:p({title:"Weight"})})}),ee=[{kind:"columnLayout",columns:[{uiLayout:["profileImage"],cols:4},{uiLayout:[["name","playerName"],["race","class"],["hp","speed","armorClass"]]}]},{kind:"whiteSpace",marginBottom:48},{kind:"columnLayout",columns:[{uiLayout:[["age","feats"],["favoriteColors"]]},{cols:4,uiLayout:[["stats.str","stats.dex"],["stats.con","stats.int"],["stats.wis","stats.cha"]]}]},{kind:"whiteSpace",marginBottom:48},{kind:"columnLayout",columns:[{uiLayout:["cosmetics.bio"]},{uiLayout:[["cosmetics.height"],["cosmetics.weight"]]}]},{kind:"whiteSpace",marginBottom:48},["customRaces","customColors"]],te={schema:Z,name:"character",uiLayout:ee,propertyMap:{displayName:"name"}};function I(a){return`FLOOR(TO_NUMBER(<base>) + BETWEEN_RANGE(-5, 10, (TO_NUMBER({$.stats.${a}.base}) / 2) - 5))`}const h=Symbol("ungrouped");class E{get allItemsUnordered(){var i;return Object.values(this.itemsByGroupingKey).flatMap(e=>e).concat(...(i=this.itemsByGroupingKey[h])!==null&&i!==void 0?i:[])}constructor(i){if(this.getAllGroups=()=>Object.keys(this.itemsByGroupingKey),this.getOne=e=>this.allItemsUnordered.find(t=>this.getIdForItem(t.item)===e),this.getAll=()=>this.allItemsUnordered,this.getMany=e=>this.allItemsUnordered.filter(t=>e(t.item)),this.getGroup=e=>{var t;return(t=this.itemsByGroupingKey[e??h])!==null&&t!==void 0?t:[]},this.create=(e,t)=>{var o,n,r;return this.allItemsUnordered.push({item:e,groupingKey:t}),(o=(n=this.itemsByGroupingKey)[r=t??h])!==null&&o!==void 0||(n[r]=[]),this.itemsByGroupingKey[t??h].push({item:e,groupingKey:t}),e},this.delete=e=>{var t;const o=this.allItemsUnordered.findIndex(s=>this.getIdForItem(s.item)===e),n=this.allItemsUnordered[o],r=(t=n.groupingKey)!==null&&t!==void 0?t:h;n&&(delete this.itemsByGroupingKey[this.getIdForItem(n.item)],this.itemsByGroupingKey[r]=this.itemsByGroupingKey[r].filter(s=>this.getIdForItem(s.item)!==e))},this.update=(e,t)=>{var o;const n=this.allItemsUnordered.find(l=>this.getIdForItem(l.item)===e);if(!n)return;const r=(o=n.groupingKey)!==null&&o!==void 0?o:h,s=t(n.item);return this.itemsByGroupingKey[r]=this.itemsByGroupingKey[r].map(l=>this.getIdForItem(l.item)===e?{item:s,groupingKey:n.groupingKey}:l),s},this.search=e=>new B(this.allItemsUnordered.map(o=>o.item),this.fuseSearchOptions).search(e).map(o=>o.item),this.searchGroup=(e,t)=>{var o;return new B(((o=this.itemsByGroupingKey[t??h])!==null&&o!==void 0?o:[]).map(r=>r.item),this.fuseSearchOptions).search(e).map(r=>r.item)},this.itemsByGroupingKey={},this.fuseSearchOptions=i.searchIndexOptions,this.getIdForItem=i.getIdForItem,i.initialItemsByGroupKey)for(const[e,t]of Object.entries(i.initialItemsByGroupKey))this.itemsByGroupingKey[e]=t.map(o=>({item:o,groupingKey:e}));this.itemsByGroupingKey[h]=[],i.initialUngroupedItems&&(this.itemsByGroupingKey[h]=i.initialUngroupedItems.map(e=>({item:e})))}}class ie{constructor(i){this.getAllGroups=()=>this.backingRepo.getAllGroups(),this.getOne=e=>this.mapItemOrUndefined(this.backingRepo.getOne(e)),this.getAll=()=>this.backingRepo.getAll().map(this.mapItem),this.getMany=e=>this.backingRepo.getMany(t=>e(this.map(t))).map(this.mapItem),this.getGroup=e=>this.backingRepo.getGroup(e).map(this.mapItem),this.create=(e,t)=>this.map(this.backingRepo.create(this.unmap(e),t)),this.delete=e=>this.backingRepo.delete(e),this.update=(e,t)=>{const o=this.backingRepo.update(e,n=>this.unmap(t(this.map(n)),n));if(o)return this.map(o)},this.search=e=>this.backingRepo.search(e).map(this.map),this.searchGroup=(e,t)=>this.backingRepo.searchGroup(e,t).map(this.map),this.mapItemOrUndefined=e=>{if(e)return this.mapItem(e)},this.mapItem=e=>({groupingKey:e.groupingKey,item:this.map(e.item)}),this.backingRepo=i.repo,this.map=i.map,this.unmap=i.unmap}}var v=function(a,i,e,t){function o(n){return n instanceof e?n:new e(function(r){r(n)})}return new(e||(e=Promise))(function(n,r){function s(u){try{c(t.next(u))}catch(m){r(m)}}function l(u){try{c(t.throw(u))}catch(m){r(m)}}function c(u){u.done?n(u.value):o(u.value).then(s,l)}c((t=t.apply(a,i||[])).next())})};class ne extends W{constructor(i){var e;super(i),this.getEntityDefinition=n=>v(this,void 0,void 0,function*(){yield this.simulateLatency();const r=this.definitionStore.getOne(n.entityDefinitionName);if(!r)throw new Error("could not find definition");return{definition:r.item}}),this.searchEntities=n=>v(this,void 0,void 0,function*(){yield this.simulateLatency();const r=this.summaryStore.searchGroup(n.query,n.entityDefinitionName),s=n.availableEntityIds&&new Set(n.availableEntityIds);return{entities:r.filter(c=>!s||s.has(c.id))}}),this.getEntitiesByIds=n=>v(this,void 0,void 0,function*(){yield this.simulateLatency();const r=new Set(n.ids);return{entities:this.summaryStore.getGroup(n.entityDefinitionName).filter(s=>r.has(s.item.id)).map(s=>s.item)}}),this.getDefaultEntities=n=>v(this,void 0,void 0,function*(){yield this.simulateLatency();const r=n.availableEntityIds&&new Set(n.availableEntityIds);return{entities:this.summaryStore.getGroup(n.entityDefinitionName).filter(l=>!r||r.has(l.item.id)).map(l=>l.item).slice(0,5)}}),this.getHydratedEntities=n=>v(this,void 0,void 0,function*(){yield this.simulateLatency();const r=new Set(n.ids);return{entities:this.entityStore.getGroup(n.entityDefinitionName).filter(s=>r.has(s.item.id)).map(s=>s.item)}}),this.updateEntity=n=>v(this,void 0,void 0,function*(){yield this.simulateLatency();const r=this.entityStore.update(n.id,s=>Object.assign(Object.assign({},s),{entityData:n.entityData}));if(!r)throw new Error("Could not find entity");return{entity:r}}),this.mockLatency=(e=i.mockLatencyMs)!==null&&e!==void 0?e:1e3;const t=Object.fromEntries(i.entities.map(({definition:n,existingEntities:r})=>[n.name,r??[]])),o=i.entities.map(n=>n.definition);this.definitionStore=new E({getIdForItem:n=>n.name,initialUngroupedItems:o,searchIndexOptions:{keys:["name"]}}),this.entityStore=new E({getIdForItem:n=>n.id,initialItemsByGroupKey:t,searchIndexOptions:{keys:["entityData.name"]}}),this.summaryStore=new ie({repo:this.entityStore,map:n=>({id:n.id,definitionName:n.definitionName,name:n.entityData.name}),unmap:(n,r)=>{var s;return{id:n.id,definitionName:n.definitionName,entityData:Object.assign(Object.assign({},(s=r==null?void 0:r.entityData)!==null&&s!==void 0?s:{}),{name:n.name})}}})}}ne.defaultOptions={entities:[{definition:G,existingEntities:z},{definition:M,existingEntities:Y},{definition:te,existingEntities:[]}]};var S;(function(a){a.Image="image",a.Video="video",a.Pdf="pdf",a.Other="other"})(S||(S={}));var k=function(a,i,e,t){function o(n){return n instanceof e?n:new e(function(r){r(n)})}return new(e||(e=Promise))(function(n,r){function s(u){try{c(t.next(u))}catch(m){r(m)}}function l(u){try{c(t.throw(u))}catch(m){r(m)}}function c(u){u.done?n(u.value):o(u.value).then(s,l)}c((t=t.apply(a,i||[])).next())})};function se(a){return new Promise(i=>setTimeout(()=>i(),a))}let ae=0;class Ge{constructor(){this.uploadedMedia=[],this.uploadMedia=i=>k(this,[i],void 0,function*({file:e}){if(e.type.startsWith("image/")){const t=yield re(e),o={assetId:`asset-${ae++}`,url:t,kind:S.Image,thumbnailUrl:t};return this.uploadedMedia.push(o),{media:o}}throw new Error(`Unsupported mime type: ${e.type}`)}),this.listUploadedMedia=i=>k(this,[i],void 0,function*({limit:e,offset:t,type:o}){return o!==S.Image?{media:[]}:(yield se(1e3),{media:this.uploadedMedia.slice(t,t+e)})}),this.generateMedias=i=>Array(i).fill(0).map((e,t)=>{const o=Math.random().toString().substring(2),n=this.randomInt(30,50)*10,r=this.randomInt(30,50)*10;return{url:`https://picsum.photos/seed/${o}/${n}/${r}`,assetId:`picsum-${t}`,thumbnailUrl:`https://picsum.photos/${n}/${r}`,kind:S.Image,alt:`Random picsum with seed = ${o}`}}),this.randomInt=(i,e)=>Math.floor(Math.random()*(e-i+1)+i),this.uploadedMedia=this.generateMedias(30)}}function re(a){return new Promise((i,e)=>{const t=new FileReader;t.readAsDataURL(a),t.onload=function(){if(typeof t.result!="string"){e({reason:"Expected string result",result:t.result});return}i(t.result)},t.onerror=function(o){e({reason:"Unexpected error",error:o})}})}function oe(){var a=!1;return{clearReset:function(){a=!1},reset:function(){a=!0},isReset:function(){return a}}}var ue=f.createContext(oe()),ce=function(){return f.useContext(ue)};function le(a,i,e){return typeof i=="function"?i.apply(void 0,e):typeof i=="boolean"?i:!!a}function de(a,i){var e=f.useRef(!1),t=f.useState(0),o=t[1],n=F(),r=ce(),s=n.defaultQueryObserverOptions(a);s.optimisticResults=!0,s.onError&&(s.onError=O.batchCalls(s.onError)),s.onSuccess&&(s.onSuccess=O.batchCalls(s.onSuccess)),s.onSettled&&(s.onSettled=O.batchCalls(s.onSettled)),s.suspense&&(typeof s.staleTime!="number"&&(s.staleTime=1e3),s.cacheTime===0&&(s.cacheTime=1)),(s.suspense||s.useErrorBoundary)&&(r.isReset()||(s.retryOnMount=!1));var l=f.useState(function(){return new i(n,s)}),c=l[0],u=c.getOptimisticResult(s);if(f.useEffect(function(){e.current=!0,r.clearReset();var m=c.subscribe(O.batchCalls(function(){e.current&&o(function(x){return x+1})}));return c.updateResult(),function(){e.current=!1,m()}},[r,c]),f.useEffect(function(){c.setOptions(s,{listeners:!1})},[s,c]),s.suspense&&u.isLoading)throw c.fetchOptimistic(s).then(function(m){var x=m.data;s.onSuccess==null||s.onSuccess(x),s.onSettled==null||s.onSettled(x,null)}).catch(function(m){r.clearReset(),s.onError==null||s.onError(m),s.onSettled==null||s.onSettled(void 0,m)});if(u.isError&&!r.isReset()&&!u.isFetching&&le(s.suspense,s.useErrorBoundary,[u.error,c.getCurrentQuery()]))throw u.error;return s.notifyOnChangeProps==="tracked"&&(u=c.trackResult(u,s)),u}function Me(a,i,e){var t=P(a,i,e);return de(t,A)}const me=w.div`
	display: grid;
	grid-template-columns: ${({isSmallViewport:a,rowHeight:i})=>a?"100%":`repeat(auto-fill, minmax(${i}px, 1fr))`};
	grid-auto-rows: ${({rowHeight:a})=>a}px;
	grid-auto-flow: row dense;
	gap: 4px;
`,C=V`
	width: 100%;
	height: 100%;
	position: relative;
	overflow: hidden;
	border-radius: 4px;
`,pe=w.div`
	${C}
	grid-row: span 2 / auto;
`,he=w.div`
	${C}
	${({isSmallViewport:a})=>!a&&"grid-column: span 2 / auto;"}
`,fe=w.div`
	${C}
`,ye=w.img`
	width: 100%;
	height: 100%;
	object-fit: cover;
`,ge=w.div`
	width: 100%;
	height: 100%;
	position: absolute;
	top: 0;
	left: 0;
	cursor: pointer;
	transition: background-color 0.2s;

	&:hover {
		background-color: rgba(0, 0, 0, 0.6);
	}
`;function be(a){const i=K(a.map(t=>({queryKey:["package-campaign-buddy-image-grid",t.url],queryFn:()=>Ie(t)}))),e=i.some(t=>t.isLoading);return{loadedImages:e?void 0:i.map(t=>t.data).filter(t=>!!t),isLoading:e}}function Ie(a){const i=new Image;return new Promise((e,t)=>{i.onload=()=>{e(Object.assign(Object.assign({},a),{width:i.width,height:i.height}))},i.onerror=o=>{t(o)},i.src=a.url})}var ve=function(a,i){var e={};for(var t in a)Object.prototype.hasOwnProperty.call(a,t)&&i.indexOf(t)<0&&(e[t]=a[t]);if(a!=null&&typeof Object.getOwnPropertySymbols=="function")for(var o=0,t=Object.getOwnPropertySymbols(a);o<t.length;o++)i.indexOf(t[o])<0&&Object.prototype.propertyIsEnumerable.call(a,t[o])&&(e[t[o]]=a[t[o]]);return e};const we=({images:a,rowHeight:i=240,onImageClicked:e,fallback:t=null})=>{const{loadedImages:o,isLoading:n}=be(a),{width:r,ref:s}=q(),l=r!==void 0&&r<i*2;return n||!o?t:g.jsx(me,{ref:s,isSmallViewport:l,rowHeight:i,children:o.map((c,u)=>g.jsx(Re,{isSmallViewport:l,image:c,onClick:e&&(()=>e(c,u))},`${c.url};${c.alt}`))})},Re=({image:a,isSmallViewport:i,onClick:e})=>{const t=Se(a);return g.jsxs(t,{isSmallViewport:i,children:[g.jsx(ye,{src:a.url,alt:a.alt}),e&&g.jsx(ge,{role:"button",onClick:e,tabIndex:0})]})};function Se(a){const i=a.width/a.height;return i>=1.5?he:i>=.75?fe:pe}const De=a=>{var{queryClient:i}=a,e=ve(a,["queryClient"]);return g.jsx(Q,{client:i,children:g.jsx(we,Object.assign({},e))})};export{De as I,Ge as M,ne as a,G as b,te as c,S as d,Me as e,ke as u};
